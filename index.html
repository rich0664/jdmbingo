<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JDM Bingo Tracker</title>
  <link rel="stylesheet" href="style.css">
  <!-- Canvas Confetti Library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <header>
    <h1>JDM Bingo Tracker</h1>
  </header>

  <!-- Score & Rank Display -->
  <div id="scoreDisplay">Total Points: 0 | Rank: N/A</div>
  <div id="rankContainer">
    <div id="rankDisplay">
      <span id="rankLetter"></span>
    </div>
  </div>

  <!-- Progress Bar -->
  <div id="progressContainer">
    <div id="progressBar"></div>
    <div id="progressText">0/25 Cars - Next Rank in 0 points</div>
  </div>

  <!-- Bingo Grid -->
  <div class="grid-container" id="grid"></div>
  
  <!-- Floating Message Container (for full-screen messages) -->
  <div id="floatingMessageContainer"></div>
  
  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2 id="modalTitle"></h2>
      <p id="modalDescription"></p>
      <p><a id="modalLink" href="#" target="_blank">Google Image Search</a></p>
    </div>
  </div>
  
  <script src="data.js"></script>
  <script>
    // Global variable for tracking active bingo lines
    let activeBingoIndices = new Set();
    // Global variable to track previous rank index for dopamine effects
    let prevRankIndex = -1;

    // Build the grid from car data in data.js
    function buildGrid() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      cars.forEach((car, index) => {
        const card = document.createElement("div");
        let rarityClass = car.rarity === 1 ? "rarity-common" : car.rarity === 2 ? "rarity-uncommon" : "rarity-rare";
        card.className = "card " + rarityClass;
        card.setAttribute("data-rarity-symbol", car.raritySymbol);
        card.innerHTML = `
          <span class="rarity-label">${car.rarityLabel}</span>
          <h3 data-index="${index}">${car.name}</h3>
          <div class="check-container">
            <input type="checkbox" id="check-${index}">
          </div>
        `;
        grid.appendChild(card);
        const saved = localStorage.getItem("car-" + index);
        const checkbox = card.querySelector("input[type='checkbox']");
        if (saved === "true") {
          checkbox.checked = true;
          card.classList.add("checked");
        }
        // Toggle check on clicking the check container
        const container = card.querySelector(".check-container");
        container.addEventListener("click", () => {
          // Only trigger dopamine effects when checking (not unchecking)
          const willBeChecked = !checkbox.checked;
          checkbox.checked = willBeChecked;
          localStorage.setItem("car-" + index, checkbox.checked);
          if (willBeChecked) {
            card.classList.add("checked");
            showFullScreenMessage(`${car.name} GET!`, "floating-get");
          } else {
            card.classList.remove("checked");
          }
          updateScore();
        });
        checkbox.addEventListener("click", (e) => {
          e.stopPropagation();
          const willBeChecked = checkbox.checked;
          localStorage.setItem("car-" + index, checkbox.checked);
          if (willBeChecked) {
            card.classList.add("checked");
            showFullScreenMessage(`${car.name} GET!`, "floating-get");
          } else {
            card.classList.remove("checked");
          }
          updateScore();
        });
      });
      updateScore();
    }

    // Modal logic
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalDescription = document.getElementById("modalDescription");
    const modalLink = document.getElementById("modalLink");
    const closeModal = document.getElementById("closeModal");

    function addTitleListeners() {
      document.querySelectorAll(".card h3").forEach(heading => {
        heading.addEventListener("click", function() {
          const index = this.getAttribute("data-index");
          showModal(cars[index]);
        });
      });
    }

    function showModal(car) {
      modalTitle.textContent = car.name;
      modalDescription.textContent = car.description;
      modalLink.href = "https://www.google.com/search?tbm=isch&q=" + encodeURIComponent(car.name);
      modal.style.display = "block";
    }
    closeModal.onclick = function() {
      modal.style.display = "none";
    };
    window.onclick = function(e) {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    };

    // Show a full-screen floating message with a given CSS class (for GET and BINGO messages)
    function showFullScreenMessage(text, cssClass) {
      const msgEl = document.createElement("div");
      msgEl.className = "floating-text " + cssClass;
      msgEl.textContent = text;
      document.getElementById("floatingMessageContainer").appendChild(msgEl);
      setTimeout(() => { msgEl.remove(); }, 1500);
    }

    // Fireworks/confetti effect (using canvas-confetti)
    function triggerFireworks(color) {
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: [color]
      });
    }

    // Score calculation and update
    function updateScore() {
      const checkboxes = document.querySelectorAll(".card input[type='checkbox']");
      let baseScore = 0;
      let bonusScore = 0;
      let checkedCount = 0;
      const state = [];
      checkboxes.forEach((cb, index) => {
        const isChecked = cb.checked;
        state[index] = isChecked;
        if (isChecked) {
          baseScore += cars[index].rarity;
          checkedCount++;
        }
      });

      // Compute current bingo lines
      const lines = [
        [0,1,2,3,4],
        [5,6,7,8,9],
        [10,11,12,13,14],
        [15,16,17,18,19],
        [20,21,22,23,24],
        [0,5,10,15,20],
        [1,6,11,16,21],
        [2,7,12,17,22],
        [3,8,13,18,23],
        [4,9,14,19,24],
        [0,6,12,18,24],
        [4,8,12,16,20]
      ];
      let currentBingoIndices = new Set();
      lines.forEach((line, lineIndex) => {
        if (line.every(idx => state[idx])) {
          currentBingoIndices.add(lineIndex);
          let product = 1;
          line.forEach(idx => {
            product *= cars[idx].rarity;
            const card = document.getElementById(`check-${idx}`).closest(".card");
            card.classList.add("bingo-active");
          });
          bonusScore += product;
          // Only show BINGO message if this line is new
          if (!activeBingoIndices.has(lineIndex)) {
            showFullScreenMessage("BINGO!", "floating-bingo");
            // Also show floating points on the rank tag
            showFloatingTextInCard(document.getElementById("rankDisplay"), `+${product}`, "#ff9800");
          }
        }
      });
      activeBingoIndices = currentBingoIndices; // update global bingo state

      const totalScore = baseScore + bonusScore;
      const rank = getRank(totalScore);
      document.getElementById("scoreDisplay").textContent =
        `Total Points: ${totalScore} | Rank: ${rank}`;
      updateProgress(checkedCount, totalScore);
      updateRankDisplay(rank);
      
      // Check for rank upgrade and trigger fireworks if upgraded
      let newRankIndex = getRankIndex(rank);
      if (newRankIndex > prevRankIndex) {
        const rankColor = getRankColor(rank);
        triggerFireworks(rankColor);
        prevRankIndex = newRankIndex;
      }
    }

    // Helper: show a small floating text on an element (for rank tag points)
    function showFloatingTextInCard(parent, text, color) {
      const floatEl = document.createElement("div");
      floatEl.className = "floating-text small";
      floatEl.style.color = color;
      floatEl.textContent = text;
      parent.appendChild(floatEl);
      setTimeout(() => { floatEl.remove(); }, 1500);
    }

    // Helper: get rank based on score
    function getRank(score) {
      const allChecked = cars.every((car, i) =>
        document.getElementById(`check-${i}`).checked
      );
      if (allChecked) return "JDM MASTER";
      if (score <= 5)   return "F";
      if (score <= 10)  return "E";
      if (score <= 20)  return "D";
      if (score <= 39)  return "C";
      if (score <= 100) return "B";
      if (score <= 253) return "A";
      if (score <= 639) return "S";
      if (score <= 796) return "SS";
      return "N/A";
    }

    // Helper: get rank index (order defined by rankThresholds array; JDM MASTER is highest)
    function getRankIndex(rank) {
      if (rank === "JDM MASTER") return rankThresholds.length;
      for (let i = 0; i < rankThresholds.length; i++) {
        if (rankThresholds[i].rank === rank) return i;
      }
      return -1;
    }

    // Helper: get main color for a given rank
    function getRankColor(rank) {
      if (rank === "JDM MASTER") return "#ffd700";
      let matched = rankThresholds.find(th => th.rank === rank);
      return matched ? matched.mainColor : "#444";
    }

    // Update progress bar and text
    function updateProgress(checkedCount, totalScore) {
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const percent = (checkedCount / 25) * 100;
      progressBar.style.width = percent + "%";
      let currentThreshold;
      for (let i = 0; i < rankThresholds.length; i++) {
        if (totalScore <= rankThresholds[i].max) {
          currentThreshold = rankThresholds[i];
          break;
        }
      }
      let nextPoints = currentThreshold ? currentThreshold.max - totalScore + 1 : 0;
      if (totalScore >= 797) {
        nextPoints = 0;
      }
      progressText.textContent = `${checkedCount}/25 Cars - Next Rank in ${nextPoints} points`;
      const color = currentThreshold ? currentThreshold.mainColor : "#28a745";
      progressBar.style.backgroundColor = color;
    }

    // Update rank tag display with animated diagonal stripes and gloss
    function updateRankDisplay(rank) {
      const rankDisplay = document.getElementById("rankDisplay");
      const rankLetter = document.getElementById("rankLetter");
      if (rank === "JDM MASTER") {
        rankLetter.textContent = "JDM MASTER";
        rankDisplay.style.backgroundImage = "repeating-linear-gradient(135deg, #ffd700, #ffd700 10px, #ffc107 10px, #ffc107 20px)";
        rankDisplay.style.animation = "glow 2s infinite";
        return;
      }
      if (rank === "N/A") {
        rankLetter.textContent = "N/A";
        rankDisplay.style.backgroundImage = "none";
        rankDisplay.style.backgroundColor = "#444";
        rankDisplay.style.animation = "";
        return;
      }
      let matched = rankThresholds.find(th => th.rank === rank);
      if (!matched) {
        rankLetter.textContent = "N/A";
        rankDisplay.style.backgroundImage = "none";
        rankDisplay.style.backgroundColor = "#444";
        rankDisplay.style.animation = "";
        return;
      }
      rankLetter.textContent = matched.symbol;
      rankDisplay.style.setProperty("--rank-main", matched.mainColor);
      rankDisplay.style.setProperty("--rank-accent", matched.accentColor);
      rankDisplay.style.backgroundImage = `repeating-linear-gradient(135deg, var(--rank-main), var(--rank-main) 10px, var(--rank-accent) 10px, var(--rank-accent) 20px)`;
      rankDisplay.style.animation = `slide ${matched.duration}s linear infinite`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      buildGrid();
      addTitleListeners();
    });
  </script>
</body>
</html>
